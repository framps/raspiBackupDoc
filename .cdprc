#!/usr/bin/env bash
# vim: set expandtab:

echo "Define helpful functions and aliases:"

edit_diffed_summaries() {
    #vi -O {de,en}/src/SUMMARY.md
    vimdiff -c "syntax off" {de,en}/src/SUMMARY.md
}

edit_translate_all_rft() {
    if command -pv fzf >/dev/null ; then
        while true; do
            FILE=$(cd de/src || exit ; rg --files-with-matches " rft" -- *.md | sort | fzf --reverse --exact --preview='cat {}' --header=">> Please select file to translate and press ENTER. (ESC to cancel.) <<")
            [ -z "$FILE" ] && break
            vi -O {de,en}/src/"$FILE"
        done
    else
        (cd de/src || exit ; rg --files-with-matches " rft" -- *.md | sort)
        read -r -p "Continue? ENTER, or Ctrl-C to cancel: " inp
        for FILE in $(cd de/src || exit ; rg --files-with-matches " rft" -- *.md | sort)
        do
            vi -O {de,en}/src/"$FILE"
            read -r -p "Continue? ENTER, or Ctrl-C to cancel: " inp
            echo  "$inp"
        done
    fi
}

edit_by_status() {
    if command -pv fzf >/dev/null ; then
        while true; do
            # TODO: this preview fails when there is a status with second field "...". Probably a quoting problem!
            STATUS=$(rg "^\[\.status\]:" --no-filename | sort -u | fzf --reverse --select-1 --exact --preview='rg --files-with-matches "^\[\.status\]:\s\s*{r2}(\s\s*\"{r3}\s{r4}\s{r5}\s{r6}\s{r7}\")*" | sort -u' --header=">> Please select status and press ENTER. (ESC to cancel.) <<")
            [ -z "$STATUS" ] && break
            VALUE=${STATUS#* }
            #echo "VALUE=$VALUE"
            while true; do
                FILE=$(rg --files-with-matches "^\[\.status\]:\s\s*${VALUE}" --glob="**/*.md" | sort | fzf --reverse --exact --preview='cat {}' --header=">> Please select file to edit and press ENTER. (ESC to cancel.) <<")
                [ -z "$FILE" ] && break
                vi "$FILE"
            done
        done
    fi
}


alias vita=edit_translate_all_rft
alias vids=edit_diffed_summaries
alias vibs=edit_by_status

alias vita
alias vids
alias vibs

echo ""


check_ssh_id() {
    IDFILE="$1"
    [ -f "$IDFILE" ] || return 1
    echo "$2"
    if ! ssh-add -T "$IDFILE" 2>/dev/null
    then
        ssh-add "$IDFILE"
    fi
    ssh-add -T "$IDFILE"
}

echo "Check/unlock SSH keys (and set possibly more private settings):"

# Examples, can/should be set to real values in .private-conf.sh
#check_ssh_id  ~/.ssh/id_my_github    "Checking ssh key(s) for GitHub ..."
#check_ssh_id  ~/.ssh/id_my_webserver "Checking ssh key(s) for webserver ..."
#export WEBSERVER="user:DUMMYPASSWORD@myserver.com"
#export WEBSERVER_ROOTDIR="httpdocs"
source .private-conf.sh
